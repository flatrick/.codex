name: Validate

on:
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install validators
        run: |
          python -m pip install --upgrade pip pyyaml tomli
          npm install --global markdownlint-cli2

      - name: Validate TOML and YAML syntax
        run: |
          python - <<'PY'
          from pathlib import Path
          import yaml

          try:
              import tomllib
          except ModuleNotFoundError:  # pragma: no cover
              import tomli as tomllib

          toml_files = [Path('config.toml'), Path('config.template.toml')]
          yaml_files = sorted(Path('skills').glob('*/agents/openai.yaml'))

          if not yaml_files:
              raise SystemExit('No skills/*/agents/openai.yaml files found.')

          for path in toml_files:
              with path.open('rb') as f:
                  tomllib.load(f)
              print(f'OK TOML: {path}')

          for path in yaml_files:
              with path.open('r', encoding='utf-8') as f:
                  yaml.safe_load(f)
              print(f'OK YAML: {path}')
          PY

      - name: Lint markdown files
        run: |
          markdownlint-cli2 README.md AGENTS.md INSTRUCTIONS.md PLAN.md "skills/*/SKILL.md"

      - name: Check markdown links
        uses: lycheeverse/lychee-action@v2
        with:
          args: >-
            --verbose
            --no-progress
            --max-retries 2
            --retry-wait-time 2
            README.md AGENTS.md INSTRUCTIONS.md PLAN.md skills/*/SKILL.md

      - name: Check required files and ignored sensitive paths
        run: |
          required_files=(.editorconfig .gitattributes .gitignore AGENTS.md PLAN.md skills-manifest.lock.json)
          for file in "${required_files[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "Missing required file: $file"
              exit 1
            fi
          done

          required_gitignore_entries=(
            '/auth.json'
            '/config.local.toml'
            '/sessions/'
            '/shell_snapshots/'
            '/state_*.sqlite'
            '/models_cache.json'
          )

          for entry in "${required_gitignore_entries[@]}"; do
            if ! grep -Fqx "$entry" .gitignore; then
              echo "Missing required .gitignore entry: $entry"
              exit 1
            fi
          done

          sensitive_paths=(
            auth.json
            config.local.toml
            sessions/example.log
            shell_snapshots/env.txt
            state_test.sqlite
            models_cache.json
          )

          for path in "${sensitive_paths[@]}"; do
            if ! git check-ignore -q "$path"; then
              echo "Expected ignored path is NOT ignored: $path"
              exit 1
            fi
          done

      - name: Verify shared-skill manifest and rust adapters
        run: |
          python - <<'PY'
          import hashlib
          import json
          from pathlib import Path

          shared = [
              "bash-developer",
              "ci-cd-operator",
              "code-review",
              "dotnet-developer",
              "frontend-qa",
              "git-hygiene",
              "mssql-developer",
              "postgresql-developer",
              "powershell-developer",
              "python-developer",
              "python-tester",
              "security-hygiene",
              "rust-developer",
              "rust-tester",
          ]

          manifest = json.loads(Path("skills-manifest.lock.json").read_text(encoding="utf-8"))
          expected = {item["name"]: item["sha256"] for item in manifest["skills"]}

          if sorted(expected) != sorted(shared):
              raise SystemExit("Manifest shared skill set does not match required list.")

          for name in shared:
              skill_path = Path("skills") / name / "SKILL.md"
              adapter_path = Path("skills") / name / "agents" / "openai.yaml"
              if not skill_path.exists():
                  raise SystemExit(f"Missing skill file: {skill_path}")
              if not adapter_path.exists():
                  raise SystemExit(f"Missing adapter file: {adapter_path}")

              digest = hashlib.sha256(skill_path.read_bytes()).hexdigest()
              if expected[name] != digest:
                  raise SystemExit(f"Manifest hash mismatch for {name}")

          print("OK: shared skills, adapters, and manifest hashes verified.")
          PY
